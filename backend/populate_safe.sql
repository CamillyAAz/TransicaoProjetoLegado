USE bdvendas;

-- Safe population script (idempotent): uses INSERT ... SELECT FROM DUAL WHERE NOT EXISTS(...) pattern
-- 1) Fornecedores (25)
INSERT INTO tb_fornecedores (nome, cnpj, email, telefone, celular, cep, endereco, numero, complemento, bairro, cidade, estado)
SELECT 'Fornecedor Pop 1','00000000000101','fpop1@ex.com','11900000001','11900000001','01000-000','Rua Pop 1',1,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 1')
UNION ALL
SELECT 'Fornecedor Pop 2','00000000000201','fpop2@ex.com','11900000002','11900000002','01000-001','Rua Pop 2',2,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 2')
UNION ALL
SELECT 'Fornecedor Pop 3','00000000000301','fpop3@ex.com','11900000003','11900000003','01000-002','Rua Pop 3',3,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 3')
UNION ALL
SELECT 'Fornecedor Pop 4','00000000000401','fpop4@ex.com','11900000004','11900000004','01000-003','Rua Pop 4',4,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 4')
UNION ALL
SELECT 'Fornecedor Pop 5','00000000000501','fpop5@ex.com','11900000005','11900000005','01000-004','Rua Pop 5',5,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 5')
UNION ALL
SELECT 'Fornecedor Pop 6','00000000000601','fpop6@ex.com','11900000006','11900000006','01000-005','Rua Pop 6',6,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 6')
UNION ALL
SELECT 'Fornecedor Pop 7','00000000000701','fpop7@ex.com','11900000007','11900000007','01000-006','Rua Pop 7',7,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 7')
UNION ALL
SELECT 'Fornecedor Pop 8','00000000000801','fpop8@ex.com','11900000008','11900000008','01000-007','Rua Pop 8',8,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 8')
UNION ALL
SELECT 'Fornecedor Pop 9','00000000000901','fpop9@ex.com','11900000009','11900000009','01000-008','Rua Pop 9',9,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 9')
UNION ALL
SELECT 'Fornecedor Pop 10','00000000001001','fpop10@ex.com','11900000010','11900000010','01000-009','Rua Pop 10',10,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 10')
UNION ALL
SELECT 'Fornecedor Pop 11','00000000001101','fpop11@ex.com','11900000011','11900000011','01000-010','Rua Pop 11',11,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 11')
UNION ALL
SELECT 'Fornecedor Pop 12','00000000001201','fpop12@ex.com','11900000012','11900000012','01000-011','Rua Pop 12',12,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 12')
UNION ALL
SELECT 'Fornecedor Pop 13','00000000001301','fpop13@ex.com','11900000013','11900000013','01000-012','Rua Pop 13',13,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 13')
UNION ALL
SELECT 'Fornecedor Pop 14','00000000001401','fpop14@ex.com','11900000014','11900000014','01000-013','Rua Pop 14',14,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 14')
UNION ALL
SELECT 'Fornecedor Pop 15','00000000001501','fpop15@ex.com','11900000015','11900000015','01000-014','Rua Pop 15',15,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 15')
UNION ALL
SELECT 'Fornecedor Pop 16','00000000001601','fpop16@ex.com','11900000016','11900000016','01000-015','Rua Pop 16',16,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 16')
UNION ALL
SELECT 'Fornecedor Pop 17','00000000001701','fpop17@ex.com','11900000017','11900000017','01000-016','Rua Pop 17',17,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 17')
UNION ALL
SELECT 'Fornecedor Pop 18','00000000001801','fpop18@ex.com','11900000018','11900000018','01000-017','Rua Pop 18',18,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 18')
UNION ALL
SELECT 'Fornecedor Pop 19','00000000001901','fpop19@ex.com','11900000019','11900000019','01000-018','Rua Pop 19',19,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 19')
UNION ALL
SELECT 'Fornecedor Pop 20','00000000002001','fpop20@ex.com','11900000020','11900000020','01000-019','Rua Pop 20',20,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 20')
UNION ALL
SELECT 'Fornecedor Pop 21','00000000002101','fpop21@ex.com','11900000021','11900000021','01000-020','Rua Pop 21',21,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 21')
UNION ALL
SELECT 'Fornecedor Pop 22','00000000002201','fpop22@ex.com','11900000022','11900000022','01000-021','Rua Pop 22',22,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 22')
UNION ALL
SELECT 'Fornecedor Pop 23','00000000002301','fpop23@ex.com','11900000023','11900000023','01000-022','Rua Pop 23',23,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 23')
UNION ALL
SELECT 'Fornecedor Pop 24','00000000002401','fpop24@ex.com','11900000024','11900000024','01000-023','Rua Pop 24',24,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 24')
UNION ALL
SELECT 'Fornecedor Pop 25','00000000002501','fpop25@ex.com','11900000025','11900000025','01000-024','Rua Pop 25',25,'','Bairro','Cidade','SP' FROM DUAL WHERE NOT EXISTS(SELECT 1 FROM tb_fornecedores WHERE nome='Fornecedor Pop 25');

-- 2) Clientes (50)
INSERT INTO tb_clientes (nome, rg, cpf, email, telefone, celular, cep, endereco, numero, complemento, bairro, cidade, estado)
SELECT CONCAT('Cliente Pop ', n), NULL, CONCAT('00000000000', LPAD(n,2,'0')), CONCAT('cliente',n,'@ex.com'), CONCAT('11900000',LPAD(n,3,'0')), CONCAT('11900000',LPAD(n,3,'0')), '01000-000', CONCAT('Rua Cliente ',n), n, '', 'Bairro', 'Cidade', 'SP'
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
  UNION ALL SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
  UNION ALL SELECT 31 UNION ALL SELECT 32 UNION ALL SELECT 33 UNION ALL SELECT 34 UNION ALL SELECT 35 UNION ALL SELECT 36 UNION ALL SELECT 37 UNION ALL SELECT 38 UNION ALL SELECT 39 UNION ALL SELECT 40
  UNION ALL SELECT 41 UNION ALL SELECT 42 UNION ALL SELECT 43 UNION ALL SELECT 44 UNION ALL SELECT 45 UNION ALL SELECT 46 UNION ALL SELECT 47 UNION ALL SELECT 48 UNION ALL SELECT 49 UNION ALL SELECT 50
) nums
WHERE NOT EXISTS (SELECT 1 FROM tb_clientes WHERE email = CONCAT('cliente',nums.n,'@ex.com'));

-- 3) Funcionários (25) — note: tb_funcionarios has UNIQUE(email)
INSERT INTO tb_funcionarios (password, last_login, is_superuser, nome, rg, cpf, email, senha, cargo, nivel_acesso, telefone, celular, cep, endereco, numero, complemento, bairro, cidade, estado, is_active, is_staff, ui_permissoes)
SELECT
'pbkdf2_sha256$dummy', NULL, 0, CONCAT('Funcionario Pop ', n), NULL, CONCAT('00000000000',LPAD(n,2,'0')), CONCAT('func',n,'@ex.com'), NULL, 'Vendedor', NULL, CONCAT('11910000',LPAD(n,3,'0')), CONCAT('11920000',LPAD(n,3,'0')), '01000-000', CONCAT('Endereco Func ',n), n, '', 'Bairro', 'Cidade', 'SP', 1, 0, NULL
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
  UNION ALL SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL SELECT 25
) nums
WHERE NOT EXISTS (SELECT 1 FROM tb_funcionarios WHERE email = CONCAT('func',nums.n,'@ex.com'));

-- 4) Produtos (50)
-- Simples: insere produtos sem for_id (NULL) para evitar expressões OFFSET dinâmicas
INSERT INTO tb_produtos (descricao, preco, qtd_estoque, for_id)
SELECT CONCAT('Produto Pop ', n), 9.99 + n, 100 + n, NULL
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
  UNION ALL SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
  UNION ALL SELECT 31 UNION ALL SELECT 32 UNION ALL SELECT 33 UNION ALL SELECT 34 UNION ALL SELECT 35 UNION ALL SELECT 36 UNION ALL SELECT 37 UNION ALL SELECT 38 UNION ALL SELECT 39 UNION ALL SELECT 40
  UNION ALL SELECT 41 UNION ALL SELECT 42 UNION ALL SELECT 43 UNION ALL SELECT 44 UNION ALL SELECT 45 UNION ALL SELECT 46 UNION ALL SELECT 47 UNION ALL SELECT 48 UNION ALL SELECT 49 UNION ALL SELECT 50
) nums
WHERE NOT EXISTS (SELECT 1 FROM tb_produtos WHERE descricao = CONCAT('Produto Pop ', nums.n));

-- 5) Vendas (40) — create vendas with observacao unique so we can link itens after
INSERT INTO tb_vendas (data_venda, total, observacao, cli_id, fun_id)
SELECT NOW(), 0.00, CONCAT('pop_test_venda_', n),
  (SELECT id FROM tb_clientes ORDER BY id LIMIT 1),
  (SELECT id FROM tb_funcionarios ORDER BY id LIMIT 1)
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
  UNION ALL SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
  UNION ALL SELECT 31 UNION ALL SELECT 32 UNION ALL SELECT 33 UNION ALL SELECT 34 UNION ALL SELECT 35 UNION ALL SELECT 36 UNION ALL SELECT 37 UNION ALL SELECT 38 UNION ALL SELECT 39 UNION ALL SELECT 40
) nums
WHERE NOT EXISTS (SELECT 1 FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', nums.n));

-- 6) Itens de Venda — for first 20 vendas insert 3 itens each (ensures >=60 itens)
INSERT INTO tb_itens_venda (quantidade, preco_unitario, subtotal, pro_id, ven_id)
SELECT 2, p.preco, 2*p.preco, p.id,
  (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1)
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
) v
JOIN (
  SELECT id, preco, ROW_NUMBER() OVER (ORDER BY id) as rn FROM tb_produtos
) p ON p.rn = v.n
WHERE NOT EXISTS (
  SELECT 1 FROM tb_itens_venda it WHERE it.ven_id = (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1) AND it.pro_id = p.id
);

-- insert second and third item per venda (use offset products)
INSERT INTO tb_itens_venda (quantidade, preco_unitario, subtotal, pro_id, ven_id)
SELECT 1, p.preco, p.preco, p.id,
  (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1)
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
) v
JOIN (
  SELECT id, preco, ROW_NUMBER() OVER (ORDER BY id) as rn FROM tb_produtos
) p ON p.rn = v.n + 20
WHERE NOT EXISTS (
  SELECT 1 FROM tb_itens_venda it WHERE it.ven_id = (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1) AND it.pro_id = p.id
);

INSERT INTO tb_itens_venda (quantidade, preco_unitario, subtotal, pro_id, ven_id)
SELECT 1, p.preco, p.preco, p.id,
  (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1)
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
) v
JOIN (
  SELECT id, preco, ROW_NUMBER() OVER (ORDER BY id) as rn FROM tb_produtos
) p ON p.rn = v.n + 40
WHERE NOT EXISTS (
  SELECT 1 FROM tb_itens_venda it WHERE it.ven_id = (SELECT id FROM tb_vendas WHERE observacao = CONCAT('pop_test_venda_', v.n) LIMIT 1) AND it.pro_id = p.id
);

-- Atualizar total das vendas
UPDATE tb_vendas v SET v.total = (
  SELECT IFNULL(SUM(it.subtotal),0) FROM tb_itens_venda it WHERE it.ven_id = v.id
) WHERE EXISTS (SELECT 1 FROM tb_itens_venda it WHERE it.ven_id = v.id);

-- 7) Movimentações (50) — use produtos e funcionarios existentes
INSERT INTO tb_movimentacoes_estoque (tipo, quantidade, data_movimento, observacao, fun_id, pro_id)
SELECT IF(n%3=0,'SAIDA','ENTRADA'), 1 + (n % 10), NOW(), CONCAT('pop_mov_', n),
  (SELECT id FROM tb_funcionarios ORDER BY id LIMIT 1),
  (SELECT id FROM tb_produtos ORDER BY id LIMIT 1)
FROM (
  SELECT 1 as n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
  UNION ALL SELECT 11 UNION ALL SELECT 12 UNION ALL SELECT 13 UNION ALL SELECT 14 UNION ALL SELECT 15 UNION ALL SELECT 16 UNION ALL SELECT 17 UNION ALL SELECT 18 UNION ALL SELECT 19 UNION ALL SELECT 20
  UNION ALL SELECT 21 UNION ALL SELECT 22 UNION ALL SELECT 23 UNION ALL SELECT 24 UNION ALL SELECT 25 UNION ALL SELECT 26 UNION ALL SELECT 27 UNION ALL SELECT 28 UNION ALL SELECT 29 UNION ALL SELECT 30
  UNION ALL SELECT 31 UNION ALL SELECT 32 UNION ALL SELECT 33 UNION ALL SELECT 34 UNION ALL SELECT 35 UNION ALL SELECT 36 UNION ALL SELECT 37 UNION ALL SELECT 38 UNION ALL SELECT 39 UNION ALL SELECT 40
  UNION ALL SELECT 41 UNION ALL SELECT 42 UNION ALL SELECT 43 UNION ALL SELECT 44 UNION ALL SELECT 45 UNION ALL SELECT 46 UNION ALL SELECT 47 UNION ALL SELECT 48 UNION ALL SELECT 49 UNION ALL SELECT 50
) nums
WHERE NOT EXISTS (SELECT 1 FROM tb_movimentacoes_estoque WHERE observacao = CONCAT('pop_mov_', nums.n));

-- Fim do script seguro
